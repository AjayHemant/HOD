<!DOCTYPE html>
<html>
<head>
    <title>Flappy Bird</title>
    <style>
        body {
            background-color: #70c5ce;
            text-align: center;
        }
        canvas {
            border: 1px solid #000;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas" width="288" height="512"></canvas>
    <audio id="music" src="background.mp3" loop></audio>
    <audio id="flap" src="flap.ogg"></audio>
    <audio id="score" src="score.ogg"></audio>
    <audio id="die" src="die.ogg"></audio>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // Audio elements
        const music = document.getElementById('music');
        const flapSound = document.getElementById('flap');
        const scoreSound = document.getElementById('score');
        const dieSound = document.getElementById('die');

        // Game states
        const states = {
            START: 0,
            PLAYING: 1,
            GAME_OVER: 2
        };
        let currentState = states.START;

        // Game variables
        let frames = 0;
        let score = 0;
        let bestScore = localStorage.getItem('bestScore') || 0;

        // Bird properties
        const bird = {
            x: 50,
            y: 150,
            width: 68,
            height: 48,
            gravity: 0.15,
            jump: 4.6,
            speed: 0,
            rotation: 0,
            draw() {
                ctx.save();
                ctx.translate(this.x + this.width / 2, this.y + this.height / 2);
                ctx.rotate(this.rotation);
                ctx.drawImage(birdImage, -this.width / 2, -this.height / 2, this.width, this.height);
                ctx.restore();
            },
            update() {
                if (currentState === states.PLAYING) {
                    this.speed += this.gravity;
                    this.y += this.speed;
                    this.rotation = Math.min(Math.PI / 4, this.speed / 10);

                    // Ground collision
                    if (this.y + this.height >= canvas.height) {
                        this.y = canvas.height - this.height;
                        changeStateToGameOver();
                    }
                }
            },
            flap() {
                this.speed = -this.jump;
                flapSound.play();
            }
        };

        // Pipe properties
        const pipes = {
            position: [],
            width: 53,
            height: 400,
            gap: 200,
            maxYPos: -150,
            dx: 2,
            reset() {
                this.position = [];
            },
            update() {
                if (currentState !== states.PLAYING) return;

                if (frames % 100 === 0) {
                    this.position.push({
                        x: canvas.width,
                        y: this.maxYPos * (Math.random() + 1)
                    });
                }

                for (let i = 0; i < this.position.length; i++) {
                    let p = this.position[i];
                    p.x -= this.dx;

                    let bottomPipeYPos = p.y + this.height + this.gap;

                    // Collision detection
                    const buffer = 10; // 10px buffer
                    if (bird.x < p.x + this.width &&
                        bird.x + bird.width - buffer > p.x &&
                        bird.y < p.y + this.height &&
                        bird.y + bird.height > p.y) {
                        changeStateToGameOver();
                    }
                    if (bird.x < p.x + this.width &&
                        bird.x + bird.width - buffer > p.x &&
                        bird.y < bottomPipeYPos + this.height &&
                        bird.y + bird.height > bottomPipeYPos) {
                        changeStateToGameOver();
                    }

                    // Move pipes to the beginning
                    if (p.x + this.width <= 0) {
                        this.position.shift();
                        score++;
                        scoreSound.play();
                        bestScore = Math.max(score, bestScore);
                        localStorage.setItem('bestScore', bestScore);
                    }
                }
            },
            draw() {
                for (let i = 0; i < this.position.length; i++) {
                    let p = this.position[i];
                    let topYPos = p.y;
                    let bottomYPos = p.y + this.height + this.gap;

                    // Draw top pillar (flipped)
                    ctx.save();
                    ctx.translate(p.x + this.width, topYPos + this.height);
                    ctx.scale(-1, -1);
                    ctx.drawImage(pillarImage, 0, 0, this.width, this.height);
                    ctx.restore();

                    // Draw bottom pillar
                    ctx.drawImage(pillarImage, p.x, bottomYPos, this.width, this.height);
                }
            }
        };

        // Load images
        let imagesLoaded = 0;
        const birdImage = new Image();
        birdImage.src = 'bird.png';
        const pillarImage = new Image();
        pillarImage.src = 'pillar.png';
        const bgImage = new Image();
        bgImage.src = 'background.png';
        const goImage = new Image();
        goImage.src = 'gameover.png';

        const images = [birdImage, pillarImage, bgImage, goImage];
        let loadedCount = 0;
        images.forEach(image => {
            image.onload = () => {
                loadedCount++;
                if (loadedCount === images.length) {
                    gameLoop();
                }
            };
        });

        // Game loop
        function gameLoop() {
            update();
            draw();
            frames++;
            requestAnimationFrame(gameLoop);
        }

        function update() {
            bird.update();
            pipes.update();
        }

        function draw() {
            ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);

            pipes.draw();
            bird.draw();
            drawScore();
        }

        function drawScore() {
            ctx.fillStyle = "#FFF";
            ctx.strokeStyle = "#000";
            ctx.lineWidth = 2;
            ctx.font = "35px sans-serif";
            ctx.textAlign = "center";

            if (currentState === states.START) {
                ctx.strokeText("Click to Start", canvas.width / 2, canvas.height / 2 - 50);
                ctx.fillText("Click to Start", canvas.width / 2, canvas.height / 2 - 50);
            } else {
                ctx.strokeText(score, canvas.width / 2, 50);
                ctx.fillText(score, canvas.width / 2, 50);
            }
            if (currentState === states.GAME_OVER) {
                const goImageWidth = goImage.width / 2;
                const goImageHeight = goImage.height / 2;
                ctx.drawImage(goImage, canvas.width / 2 - goImageWidth / 2, canvas.height / 2 - goImageHeight / 2 - 50, goImageWidth, goImageHeight);
                ctx.strokeText("Click to Restart", canvas.width / 2, canvas.height / 2 + 50);
                ctx.fillText("Click to Restart", canvas.width / 2, canvas.height / 2 + 50);
                ctx.strokeText(`Best: ${bestScore}`, canvas.width / 2, canvas.height / 2 + 100);
                ctx.fillText(`Best: ${bestScore}`, canvas.width / 2, canvas.height / 2 + 100);
            }
        }

        // Event listener
        canvas.addEventListener('click', () => {
            switch (currentState) {
                case states.START:
                    currentState = states.PLAYING;
                    music.play();
                    break;
                case states.PLAYING:
                    bird.flap();
                    break;
                case states.GAME_OVER:
                    bird.y = 150;
                    bird.speed = 0;
                    bird.rotation = 0;
                    pipes.reset();
                    score = 0;
                    currentState = states.START;
                    music.currentTime = 0;
                    music.pause();
                    break;
            }
        });

        function changeStateToGameOver() {
            if (currentState === states.PLAYING) {
                currentState = states.GAME_OVER;
                music.pause();
                dieSound.play();
            }
        }
    </script>
</body>
</html>